<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script
      src="https://code.jquery.com/jquery-3.6.4.js"
      integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E="
      crossorigin="anonymous"
    ></script>
    <script>
      $(function () {
        const player = $("#player");
        const triangle = $('#triangle');
        const scoreElement = $('#score');
        let isJumping = false;
        let rotationCount = 0;
        let isGameOver = false;
        let score = 0;
        let gameInterval;
        let obstaclePassed = false;
        let spacebarCount = 0; // 스페이스바 눌린 횟수를 저장하는 변수

        gameStart();

        function gameStart() {
          setKeyboardEvent();
          triangleStart();
          checkCollision();
        
        }
        function triangleStart() {
        const randomSpeed = Math.floor(Math.random() * 2000) + 1000; // 랜덤 속도 설정 (1초에서 3초 사이)
        const randomPosition = Math.floor(Math.random() * 400) + 100; // 랜덤 위치 설정 (100px에서 500px 사이)
        // 적이 오른쪽에서 왼쪽으로 이동
        triangle.animate({ right: '1000px' }, randomSpeed, function() {
          triangle.css("right","-100px");
            if (!isGameOver) {
              triangleStart();
            }
        });
    }

        function jump() {
          
          if (isJumping) return;
          isJumping = true;
          rotationCount++;
          const targetRotation = rotationCount * 180;

          player.animate({ bottom: "+=100px" },{
              duration: 200,
              step: function (now) {
                $(this).css({transform: `rotate(${now + targetRotation}deg)`,
                });
              },
              complete: function () {
                player.animate(
                  { bottom: "-=100px" },
                  {
                    duration: 250,
                    step: function (now) {
                      $(this).css({
                        transform: `rotate(${targetRotation - now}deg)`,
                      });
                    },
                    complete: function () {
                      isJumping = false;
                      player.css({ transform: `rotate(${targetRotation}deg)` });
                    },
                  }
                );
              },
            }
          );
          
        }

        function setKeyboardEvent() {
          $(document).keydown(function (e) {
            if (e.key === " ") {
              // 스페이스바 키
              jump();
            }
    
          });
        }

        function checkCollision() {
        gameInterval = setInterval(function() {
            const playerPosition = player.position();
            const trianglePosition = triangle.position();
            const playerWidth = player.width();
            const triangleWidth = triangle.width();
            const triangleHeight = triangle.height();

            if (
              playerPosition.left + playerWidth >= trianglePosition.left &&
              playerPosition.left <= trianglePosition.left + triangleWidth &&
              playerPosition.top + playerWidth >= trianglePosition.top &&
              playerPosition.top <= trianglePosition.top + triangleHeight
            ) {
                clearInterval(gameInterval);
                isGameOver = true;
                alert("Circle이 적에게 닿았습니다! 게임 오버입니다.");

                const restart = confirm("게임을 다시 시작하시겠습니까?");
                if (restart) {
                    resetGame();
                }
            } else if (
              playerPosition.left > trianglePosition.left + triangleWidth &&
                !obstaclePassed
            ) {
                obstaclePassed = true;
                increaseScore(100);
            } else if (playerPosition.left < trianglePosition.left) {
                obstaclePassed = false;
            }
        }, 10);
    }

    function increaseScore(points) {
        score += points;
        scoreElement.text("점수: " + score);
    }

    function resetGame() {
        isGameOver = false;
        player.css("bottom", "100px");
        score = 0;
            scoreElement.text("점수: " + score);
            gameStart();
        }


      });
    </script>
    <style>
      #container {
        position: absolute;
        width: 880px;
        height: 600px;
        border: 1px black solid;
        margin: 100px auto;
        overflow: hidden;
        left: 500px;
        top: 100px;
      }
      #bottom-background {
        position: absolute;
        bottom: 0px;
        left: 0px;
        width: 1760px;
        height: 100px;
        position: absolute;
        background: url("images/bottom.jpg");
        animation: slide 1.5s linear infinite;
      }
      @keyframes slide {
        from {
          transform: translateX(0);
        }

        to {
          transform: translateX(-800px);
        }
      }
      #middle-background {
        position: absolute;
        top: 0px;
        height: 100%;
        z-index: -100;
      }
      #player {
        position: absolute;
        bottom: 100px;
        left: 150px;
      }
      
      #triangle {
        position: absolute;
        right: -50px;
        bottom: 95px;
        width: 35px;
        height: 32px;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div class="sliding-background"></div>
      <img id="bottom-background" src="images/bottom.jpg" alt="" />
      <img id="middle-background" src="images/all.jpg" alt="" />
      <img id="player" src="images/player.jpg" alt="" />
      <img id="triangle" src="images/huddle.png" alt="" />
      <h3 id="score">점수: 0</h3>
      <div id="gameover_screen">
        Game Over
        <!-- <input type="button" value="재시작"> -->
      </div>

      <!-- <div id="score">점수 : 0</div> -->
    </div>
  </body>
</html>